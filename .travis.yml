cache:
  directories:
    - ~/.ghc
    - ~/.cabal

matrix:
  include:
    # MacOS builds
    - env: CABALVER=1.24 GHCVER=7.10.3
      compiler: "ghc-$GHCVER"
      os: osx
      language: generic
    - env: CABALVER=1.24 GHCVER=8.0.2
      compiler: "ghc-$GHCVER"
      os: osx
      language: generic
    - env: CABALVER=1.24 GHCVER=8.2.2
      compiler: "ghc-$GHCVER"
      os: osx
      language: generic
    - env: CABALVER=1.24 GHCVER=8.4.1
      compiler: "ghc-$GHCVER"
      os: osx
      language: generic

    # Linux builds
    - env: CABALVER=1.24 GHCVER=7.10.3
      compiler: "ghc-$GHCVER"
      addons: {apt: {packages: [cabal-install-$CABALVER, ghc-GHCVER],sources: [hvr-ghc]}}
      os: linux
      language: haskell
      sudo: false
    - env: CABALVER=1.24 GHCVER=8.0.2
      compiler: "ghc-$GHCVER"
      addons: {apt: {packages: [cabal-install-$CABALVER, ghc-GHCVER],sources: [hvr-ghc]}}
      os: linux
      language: haskell
      sudo: false
    - env: CABALVER=1.24 GHCVER=8.2.2
      compiler: "ghc-$GHCVER"
      addons: {apt: {packages: [cabal-install-$CABALVER, ghc-GHCVER],sources: [hvr-ghc]}}
      os: linux
      language: haskell
      sudo: false
    - env: CABALVER=1.24 GHCVER=8.4.1
      compiler: "ghc-$GHCVER"
      addons: {apt: {packages: [cabal-install-$CABALVER, ghc-GHCVER],sources: [hvr-ghc]}}
      os: linux
      language: haskell
      sudo: false

  allow_failures:
    - compiler: "ghc-8.4.1"

before_install:
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew update; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew install ghc-$GHCVER cabal-install-$CABALVER; fi
  - export PATH=/opt/ghc/$GHCVER/bin:/opt/cabal/$CABALVER/bin:$PATH

install:
  - cabal --version
  - echo "$(ghc --version) [$(ghc --print-project-git-commit-id 2> /dev/null || echo '?')]"
  - travis_retry cabal update
  - cabal install --enable-benchmarks --enable-tests --only-dependencies
  - cabal install hpc-coveralls

script:
  - cabal configure --enable-coverage --enable-benchmarks --enable-tests -v2
  - cabal sdist
  - cabal build
  - cabal test --show-details=always
  - cabal check
  - cabal haddock

after_script:
  - export PATH=~/.cabal/bin:$PATH
  - hpc-coveralls --coverage-mode=StrictlyFullLines
                  --exclude-dir=bench
                  --exclude-dir=tests
                  test-suite

notifications:
  email: false
